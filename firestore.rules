rules_version = '2';

// ─────────────────────────────────────────────────────────────────────
// AppNotesBG — Firestore Security Rules
//
// Arquitectura: Frontend → NestJS (Admin SDK) → Firestore
//
// El Admin SDK bypasea TODAS estas reglas.
// Estas reglas solo aplican a lecturas directas del cliente (@angular/fire).
// para listeners en tiempo real (onSnapshot).
//
// PRINCIPIO: El cliente NUNCA escribe directamente a Firestore.
//            Toda escritura pasa por NestJS (Admin SDK), que bypasea estas reglas.
// ─────────────────────────────────────────────────────────────────────

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helpers ─────────────────────────────────────────────────────

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isCollaborator(collaborators) {
      return isAuthenticated()
        && 'sharing' in resource.data
        && resource.data.sharing.collaborators.hasAny([
            { user_id: request.auth.uid, permission: 'view' },
            { user_id: request.auth.uid, permission: 'edit' },
            { user_id: request.auth.uid, permission: 'comment' },
          ]);
    }

    // ─── users ─────────────────────────────────────────────────────────────

    match /users/{userId} {
      // El usuario solo puede leer/actualizar su propio perfil.
      // Toda escritura (onboarding, actualización de preferencias)
      // pasa por NestJS (Admin SDK), que bypasea estas reglas.
      allow read, write: if isOwner(userId);
      allow create: if isOwner(userId)
        && request.resource.data.status in ['active', 'suspended', 'deleted']
        && 'preferences' in request.resource.data
        && 'security' in request.resource.data
        && 'quotas' in request.resource.data
        && 'audit' in request.resource.data;
    }

    // ─── notebooks ─────────────────────────────────────────────────────

    match /notebooks/{notebookId} {
      // El cliente puede escuchar libretas en tiempo real.
      // Toda escritura va por NestJS.
      allow read: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;
      allow create: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;
    }

    // ─── notes ─────────────────────────────────────────────────────────────

    match /notes/{noteId} {
      // El cliente puede escuchar sus notas en tiempo real.
      // Los colaboradores con permiso 'view'/'comment' pueden leer.
      // Los colaboradores con permiso 'edit' pueden leer/actualizar.
      // Toda escritura (creación, actualización) va por NestJS.
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid
        || isCollaborator(resource.data.collaborators)
      );
      allow create: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;
      allow update: if isAuthenticated()
        && (
          resource.data.user_id == request.auth.uid
          || isCollaborator(resource.data.collaborators)
        );
      allow delete: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;
    }

    // ─── note_history ─────────────────────────────────────────────────────

    match /note_history/{historyId} {
      // Solo el propietario puede leer el historial.
      // Inmutable: ni el cliente ni NestJS actualizan/eliminan
      // (salvo el pruneHistory que es via Admin SDK).
      allow read: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;
      allow create, update, delete: if false; // Solo Admin SDK
    }

    // ─── themes ─────────────────────────────────────────────────────

    match /themes/{themeId} {
      allow read: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;
      allow create, update, delete: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;
    }

    // ─── attachments ─────────────────────────────────────────────────────

    match /attachments/{attachmentId} {
      allow read: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;
      allow create: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;
      allow update, delete: if isAuthenticated()
        && resource.data.user_id == request.auth.uid;
    }

    // ─── invitations ─────────────────────────────────────────────────────

    match /invitations/{invitationId} {
      // El invitado y el creador pueden leer la invitación.
      // El creador puede crear/revocar. El invitado puede aceptar/rechazar.
      allow read: if isAuthenticated() && (
        resource.data.invited_by_uid == request.auth.uid
        || resource.data.invited_email == request.auth.token.email
      );
      allow create: if isAuthenticated()
        && resource.data.invited_by_uid == request.auth.uid;
      allow update: if isAuthenticated() && (
        (resource.data.invited_by_uid == request.auth.uid && resource.data.status in ['revoked'])
        || (
          resource.data.invited_email == request.auth.token.email
          && resource.data.status in ['accepted', 'rejected']
        )
      );
      allow delete: if isAuthenticated()
        && resource.data.invited_by_uid == request.auth.uid;
    }

    // ─── audit_logs ─────────────────────────────────────────────────────

    match /audit_logs/{logId} {
      // Completamente inaccesible desde el cliente.
      // Solo accesible desde Cloud Functions o Admin SDK.
      allow read, write: if false;
    }

    // ─── Catch-all: bloquear cualquier otra colección ─────────────────────

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
